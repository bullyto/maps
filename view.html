<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Suivi GPS — Carte</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b0f14; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.08);
      --txt:#e9eef7; --muted:rgba(233,238,247,.68);
      --good:#2fe37b; --bad:#ff4d4d; --warn:#ffcc00; --line:rgba(255,255,255,.10);
      --radius:18px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    #app{height:100%;display:flex;flex-direction:column;}
    header{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .title{font-size:20px;font-weight:800;letter-spacing:.2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:var(--card);border:1px solid var(--line);
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 0 rgba(255,204,0,.45);animation:pulse 1.4s infinite;}
    .dot.ok{background:var(--good);box-shadow:0 0 0 0 rgba(47,227,123,.35);}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 0 rgba(255,77,77,.35);}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,204,0,.40)}70%{box-shadow:0 0 0 10px rgba(255,204,0,0)}100%{box-shadow:0 0 0 0 rgba(255,204,0,0)}}

    .panel{
      margin:0 14px 10px;
      padding:12px 12px;
      border-radius:var(--radius);
      background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid var(--line);
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    }
    .kv{display:flex;flex-direction:column;gap:2px;min-width:120px}
    .k{font-size:11px;color:var(--muted)}
    .v{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;max-width:46vw}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    button{
      appearance:none;border:1px solid var(--line);background:var(--card2);color:var(--txt);
      padding:10px 12px;border-radius:14px;font-weight:800;cursor:pointer;
    }
    button:active{transform:translateY(1px)}
    .small{font-size:12px;font-weight:800;padding:9px 10px;border-radius:12px}
    .ghost{background:transparent}
    #map{flex:1;min-height:280px;margin:0 14px 14px;border-radius:22px;overflow:hidden;border:1px solid var(--line)}
    .hint{padding:0 14px 14px;color:var(--muted);font-size:12px}
    .errorBox{
      margin:0 14px 10px;padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.08);
      color:rgba(255,220,220,.95);
      display:none;
    }
    a{color:#9fd2ff}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;border:1px solid var(--line)}
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="title">Suivi GPS — Carte</div>
    <div class="pill" id="statusPill"><span class="dot" id="dot"></span><span id="statusTxt">En attente…</span></div>
  </header>

  <div class="panel">
    <div class="kv">
      <div class="k">API</div>
      <div class="v" id="apiTxt">—</div>
    </div>
    <div class="kv">
      <div class="k">Token</div>
      <div class="v" id="tokenTxt">—</div>
    </div>
    <div class="kv">
      <div class="k">Dernière maj</div>
      <div class="v" id="lastTxt">—</div>
    </div>

    <div class="controls">
      <button id="btnStart">Démarrer</button>
      <button id="btnStop" class="ghost">Stop</button>
      <button id="btnRecenter" class="small">Recentrer</button>
      <button id="btnCopy" class="small">Copier lien</button>
    </div>
  </div>

  <div class="errorBox" id="errBox"></div>

  <div id="map"></div>

  <div class="hint">
    Astuce : ouvre avec <code>?api=…&token=…</code>.<br/>
    Exemple : <code>view.html?api=https%3A%2F%2Fand-suivi...workers.dev&token=TON_TOKEN</code>
  </div>
</div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const api = (qs.get('api') || '').trim().replace(/\/+$/,''); // sans slash final
  const token = (qs.get('token') || '').trim();

  const $ = (id) => document.getElementById(id);
  const apiTxt = $('apiTxt'), tokenTxt = $('tokenTxt'), lastTxt = $('lastTxt');
  const errBox = $('errBox');
  const dot = $('dot'), statusTxt = $('statusTxt');

  apiTxt.textContent = api || '—';
  tokenTxt.textContent = token ? token.slice(0,8)+'…'+token.slice(-4) : '—';

  let timer = null;
  let map, marker, accuracyCircle;
  let lastLatLng = null;

  function setStatus(kind, text){
    statusTxt.textContent = text;
    dot.classList.remove('ok','bad');
    if(kind === 'ok') dot.classList.add('ok');
    else if(kind === 'bad') dot.classList.add('bad');
  }
  function showError(msg){
    errBox.style.display = 'block';
    errBox.textContent = msg;
  }
  function clearError(){
    errBox.style.display = 'none';
    errBox.textContent = '';
  }

  function initMap(){
    map = L.map('map', { zoomControl: true, preferCanvas: true });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    map.setView([42.6887, 2.8948], 13);

    const carIcon = L.divIcon({
      className: 'car-icon',
      html: `<div style="
        width:18px;height:18px;border-radius:999px;
        background:rgba(47,227,123,.95);
        border:2px solid rgba(255,255,255,.9);
        box-shadow:0 10px 30px rgba(0,0,0,.35);
      "></div>`,
      iconSize: [18,18],
      iconAnchor: [9,9],
    });

    marker = L.marker([42.6887, 2.8948], { icon: carIcon }).addTo(map);
    accuracyCircle = L.circle([42.6887, 2.8948], { radius: 0 }).addTo(map);
  }

  function formatTime(ts){
    if(!ts) return '—';
    const d = new Date(ts);
    if(isNaN(d.getTime())) return '—';
    return d.toLocaleString('fr-FR');
  }

  async function fetchLatest(){
    if(!api || !token){
      setStatus('bad','Paramètres manquants');
      showError("Il manque 'api' ou 'token' dans l'URL. Exemple : view.html?api=...&token=...");
      return;
    }
    const url = `${api}/latest?token=${encodeURIComponent(token)}`;
    try{
      const r = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
      const txt = await r.text();
      let data = null;
      try { data = JSON.parse(txt); } catch(e) {}

      if(!r.ok){
        setStatus('bad', `Erreur ${r.status}`);
        showError(data?.error ? data.error : (txt || `HTTP ${r.status}`));
        return;
      }
      if(!data || !data.ok){
        setStatus('bad','Réponse invalide');
        showError(data?.error || 'Réponse JSON invalide.');
        return;
      }

      clearError();
      setStatus('ok','En ligne');

      const latest = data.latest || data;
      const lat = Number(latest.lat);
      const lng = Number(latest.lng);
      const acc = latest.acc != null ? Number(latest.acc) : null;
      const ts = latest.ts != null ? Number(latest.ts) : null;

      if(Number.isFinite(lat) && Number.isFinite(lng)){
        const ll = [lat, lng];
        lastLatLng = ll;

        marker.setLatLng(ll);

        if(acc && Number.isFinite(acc) && acc > 0){
          accuracyCircle.setLatLng(ll);
          accuracyCircle.setRadius(acc);
          accuracyCircle.setStyle({ color: 'rgba(47,227,123,.55)', fillColor: 'rgba(47,227,123,.18)', fillOpacity: 0.35 });
        } else {
          accuracyCircle.setRadius(0);
        }

        lastTxt.textContent = formatTime(ts);

        if(fetchLatest._first){
          map.setView(ll, 16);
          fetchLatest._first = false;
        }
      } else {
        setStatus('bad','Pas de coordonnée');
        showError("Le serveur répond OK mais sans lat/lng valides.");
      }
    } catch(err){
      setStatus('bad','Erreur réseau');
      showError(String(err && err.message ? err.message : err));
    }
  }
  fetchLatest._first = true;

  function start(){
    if(timer) return;
    fetchLatest();
    timer = setInterval(fetchLatest, 5000);
  }
  function stop(){
    if(!timer) return;
    clearInterval(timer);
    timer = null;
    setStatus('warn','Stop');
  }

  $('btnStart').addEventListener('click', start);
  $('btnStop').addEventListener('click', stop);

  $('btnRecenter').addEventListener('click', () => {
    if(lastLatLng) map.setView(lastLatLng, Math.max(map.getZoom(), 16));
  });

  $('btnCopy').addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(location.href);
      $('btnCopy').textContent = 'Copié ✓';
      setTimeout(()=> $('btnCopy').textContent = 'Copier lien', 900);
    } catch(e){
      showError("Impossible de copier automatiquement. Copie le lien manuellement.");
    }
  });

  initMap();
  if(api && token) start();
  else setStatus('bad','Paramètres manquants');
})();
</script>
</body>
</html>
