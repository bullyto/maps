<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Suivi GPS — Track</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#0e0f13;
  color:#fff
}
.container{
  max-width:720px;
  margin:auto;
  padding:16px
}
h1{margin:0 0 12px}
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:#1c1f2a;
  margin-right:6px;
  font-size:13px
}
.card{
  background:#151823;
  border-radius:16px;
  padding:16px;
  margin-top:12px
}
label{
  display:block;
  font-size:13px;
  opacity:.8;
  margin-bottom:6px
}
input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  background:#0f1220;
  color:#fff;
  margin-bottom:12px
}
button{
  padding:12px 16px;
  border-radius:12px;
  border:none;
  background:#2f6bff;
  color:#fff;
  font-size:16px;
  margin-right:8px
}
button.secondary{background:#2a2e40}
.status{margin-top:10px;font-size:14px}
.red{color:#ff4d4d}
.green{color:#4dff88}
.small{font-size:12px;opacity:.7}
</style>
</head>

<body>
<div class="container">
  <h1>Suivi GPS</h1>

  <div>
    <span class="badge" id="apiBadge">API: —</span>
    <span class="badge" id="tokenBadge">Token: —</span>
  </div>

  <div class="small" id="last">Dernière maj: —</div>

  <div class="card">
    <label>URL de ton Worker</label>
    <input id="apiInput" placeholder="https://and-suivi.apero-nuit-du-66.workers.dev">

    <label>Token</label>
    <input id="tokenInput" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">

    <button id="startBtn">Démarrer</button>
    <button class="secondary" id="stopBtn">Stop</button>
    <button class="secondary" id="copyBtn">Copier le lien</button>

    <div class="status" id="status">
      <span class="red">●</span> En attente…
    </div>
  </div>
</div>

<script>
const qs = new URLSearchParams(location.search);

const apiInput = document.getElementById("apiInput");
const tokenInput = document.getElementById("tokenInput");
const apiBadge = document.getElementById("apiBadge");
const tokenBadge = document.getElementById("tokenBadge");
const statusEl = document.getElementById("status");
const lastEl = document.getElementById("last");

if(qs.get("api")){
  apiInput.value = qs.get("api");
  apiBadge.textContent = "API: " + qs.get("api");
}
if(qs.get("token")){
  tokenInput.value = qs.get("token");
  tokenBadge.textContent = "Token: " + qs.get("token");
}

let watchId = null;

document.getElementById("startBtn").onclick = () => {
  if(!apiInput.value || !tokenInput.value){
    alert("API et token requis");
    return;
  }

  apiBadge.textContent = "API: " + apiInput.value;
  tokenBadge.textContent = "Token: " + tokenInput.value;

  watchId = navigator.geolocation.watchPosition(pos => {
    fetch(apiInput.value + "/track", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        token: tokenInput.value,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        ts: Date.now()
      })
    });

    statusEl.innerHTML = '<span class="green">●</span> Position envoyée';
    lastEl.textContent = "Dernière maj: " + new Date().toLocaleTimeString();
  }, err => {
    statusEl.innerHTML = '<span class="red">●</span> Erreur GPS';
  }, { enableHighAccuracy:true });
};

document.getElementById("stopBtn").onclick = () => {
  if(watchId) navigator.geolocation.clearWatch(watchId);
  statusEl.innerHTML = '<span class="red">●</span> Arrêté';
};

document.getElementById("copyBtn").onclick = () => {
  const url = location.origin + location.pathname +
    "?api=" + encodeURIComponent(apiInput.value) +
    "&token=" + encodeURIComponent(tokenInput.value);
  navigator.clipboard.writeText(url);
  alert("Lien copié");
};
</script>
</body>
</html>
